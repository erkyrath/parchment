/*

ZVM - the ifvms.js implementation of the Z-Machine
==================================================

Built: 2011-12-23

Copyright (c) 2011 The ifvms.js team
BSD licenced
http://github.com/curiousdannii/ifvms.js

*/
(function(l,k){if(![].indexOf){Array.prototype.indexOf=function(M,L){for(var K=L||0,J=this.length;K<J;K++){if(this[K]==M){return K}}return -1}}var C=function(J,L){for(var K in L){J[K]=L[K]}return J},x=l.console||{log:function(){},info:function(){},warn:function(){}},j=function(J){return((J&32768)?~65535:0)|J},e=function(J){return J&65535},b=function(M){var L=0,K=M.length,J=[];while(L<K){J[L/2]=M[L++]<<8|M[L++]}return J};var E=0,f=E?function(K){var J=new ArrayBuffer(K),K=new DataView(J);K.buffer=J;return K}:function(J){J=J.slice();return{data:J,getUint8:function(K){return J[K]},getUint16:function(K){return J[K]<<8|J[K+1]},getBuffer:function(L,K){return J.slice(L,L+K)},getBuffer16:function(L,K){return b(J.slice(L,L+K*2))},setUint8:function(K,L){return J[K]=L&255},setUint16:function(K,L){J[K]=(L>>8)&255;J[K+1]=L&255;return L&65535},setBuffer:function(L,K){return J=J.slice(0,L).concat(K,J.slice(L+K.length))}}};var m=Object.subClass({init:function(J,K){this.e=J;this.v=K},write:function(){return this.v},U2S:function(){return j(this.v)}}),y=m.subClass({write:function(L){var K=this.v,J=arguments.length,L=L&&L.write?L.write():L,M=this.e.globals+(K-16)*2;if(this.returnval){return"e.variable("+K+","+L+")"}if(K==0){return J?"s.push("+L+")":"s.pop()"}else{if(K<16){K--;return"l["+K+"]"+(J?"="+L:"")}else{if(J){return"m.setUint16("+M+","+L+")"}else{return"m.getUint16("+M+")"}}}},U2S:function(){return"e.U2S("+this.write()+")"}}),w=Object.subClass({init:function(N,L,O,K,M,J){this.e=N;this.context=L;this.code=O;this.pc=K;this.next=M;this.operands=J;if(this.post){this.post()}},write:function(){return this.label()+(this.func?this.func.apply(this,this.operands):"")},args:function(K){var J=0,L=[];while(J<this.operands.length){L.push(this.operands[J++].write())}return L.join(K)},label:function(){return"/* "+this.pc+"/"+this.code+" */ "}}),I=w.subClass({stopper:1}),r=I.subClass({storer:1,post:function(){this.storer=this.operands.pop();this.origfunc=this.func;this.func=function(){return"e.pc="+this.next+";"+this.origfunc.apply(this,arguments)}}}),d=Object.subClass({init:function(J,K){this.ops=J||[];this.code=K||"||"},write:function(){var J=0,K=[],L;while(J<this.ops.length){L=this.ops[J++];K.push(L.func?(L.iftrue?"":"!(")+L.func.apply(L,L.operands)+(L.iftrue?"":")"):L.write())}return(this.invert?"(!(":"(")+K.join(this.code)+(this.invert?"))":")")}}),a=w.subClass({brancher:1,keyword:"if",post:function(){var J,L,K=this.operands.pop(),M=K[1];this.iftrue=K[0];if(M==0||M==1){J="e.ret("+M+")"}else{M+=this.next-2;this.context.targets.push(M);J="e.pc="+M}this.result=J+"; return";this.offset=M;this.cond=new d();this.labels=[];if(this.context.ops.length){L=this.context.ops.pop();if(L.offset==M){this.cond=L.cond;this.labels=L.labels}else{this.context.ops.push(L)}}this.cond.ops.push(this);this.labels.push(this.pc+"/"+this.code)},write:function(){var K=0,J=this.result;if(J instanceof v){J=J.write()+(J.stopper?"; return":"");if(this.result.ops.length>1){J="\n"+J+"\n"}}return"/* "+this.labels.join()+" */ "+this.keyword+this.cond.write()+" {"+J+"}"}}),q=a.subClass({storer:1,post:function(){this._super();this.storer=this.operands.pop();this.storer.returnval=1}}),h=w.subClass({storer:1,post:function(){this.storer=this.operands.pop()},write:function(){var J=this._super();return this.storer?this.storer.write(J):J}}),i=I.subClass({post:function(){this.result={v:-1}},write:function(){var J=this.operands.shift();return this.label()+"e.call("+J.write()+","+this.result.v+","+this.next+",["+this.args()+"])"}}),A=i.subClass({storer:1,post:function(){this.result=this.operands.pop()}}),v=Object.subClass({init:function(K,J){this.e=K;this.pc=J;this.ops=[];this.targets=[]},write:function(){var L=this.ops,J=[],K=0;while(K<L.length){J.push(L[K++].write())}return J.join(";")}}),u=v.subClass({write:function(){return"var l=e.l,m=e.m,s=e.s;\n"+this._super()}}),s=function(K,L,J){var J=J||{};if(L){J.func=L}return K.subClass(J)};var G=IFF.subClass({init:function(K){this._super(K);if(K){if(this.type!="IFZS"){throw new Error("Not a Quetzal savefile")}for(var L=0,J=this.chunks.length;L<J;L++){var M=this.chunks[L].type,N=this.chunks[L].data;if(M=="CMem"||M=="UMem"){this.memory=N;this.compressed=(M=="CMem")}else{if(M=="Stks"){this.stacks=N}else{if(M=="IFhd"){this.release=N.slice(0,2);this.serial=N.slice(2,8);this.checksum=N.slice(8,10);this.pc=N[10]<<16|N[11]<<8|N[12]}}}}}},write:function(){this.type="IFZS";var K=this.pc,J=this.release.concat(this.serial,this.checksum,(K>>16)&255,(K>>8)&255,K&255);this.chunks=[{type:"IFhd",data:J},{type:(this.compressed?"CMem":"UMem"),data:this.memory},{type:"Stks",data:this.stacks}];return this._super()}});var p=(function(){var K={8:8,13:13,27:27,37:131,38:129,39:132,40:130},J=96;while(J<106){K[J]=49+J++}J=112;while(J<124){K[J]=21+J++}return K})(),z=Object.subClass({init:function(R){var O=R.m,L=O.getUint16(52),N=R.extension_table(3),J=N&&O.getUint8(N++),P,K=[],Q=0,M=96;this.e=R;this.maxaddr=O.getUint16(26)*R.packing_multipler;this.make_alphabet(L?O.getBuffer(L,78):this.text_to_zscii("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ*\r0123456789.,!?_#'\"/\\-:()"));this.make_unicode(N?O.getBuffer16(N,J):this.text_to_zscii(unescape("%E4%F6%FC%C4%D6%DC%DF%BB%AB%EB%EF%FF%CB%CF%E1%E9%ED%F3%FA%FD%C1%C9%CD%D3%DA%DD%E0%E8%EC%F2%F9%C0%C8%CC%D2%D9%E2%EA%EE%F4%FB%C2%CA%CE%D4%DB%E5%C5%F8%D8%E3%F1%F5%C3%D1%D5%E6%C6%E7%C7%FE%F0%DE%D0%A3%u0153%u0152%A1%BF"),1));P=O.getUint16(24);if(P){while(Q<M){K.push(this.decode(O.getUint16(P+2*Q++)*2,0,1))}}this.abbr=K;this.dictionaries={};this.dict=O.getUint16(8);this.parse_dict(this.dict)},make_alphabet:function(K){var L=[[],[],[]],J=0;while(J<78){L[parseInt(J/26)][J%26]=K[J++]}this.alphabets=L},make_unicode:function(M){var L={},J={10:13},K=0;while(K<M.length){L[K+155]=M[K];J[M[K]]=155+K++}this.unicode_table=L;this.reverse_unicode_table=J;this.unicode_callback=function(N){return String.fromCharCode(L[N.charCodeAt(0)]||63)}},decode:function(Q,K,T){var N=this.e.m,R=Q,J,M=[],O=0,P,L=0,S=[];if(this.e.jit[Q]){return this.e.jit[Q]}K=K?K+Q:this.maxaddr;while(Q<K){J=N.getUint16(Q);Q+=2;M.push(J>>10&31,J>>5&31,J&31);if(J&32768){break}}while(O<M.length){P=M[O++];if(P==0){S.push(32)}else{if(P<4){S=S.concat(this.abbr[32*(P-1)+M[O++]])}else{if(P<6){L=P}else{if(L==2&&P==6){if(O+1<M.length){S.push(M[O++]<<5|M[O++])}}else{S.push(this.alphabets[L][P-6])}}}}L=L<4?0:L-3}if(!T){S=new String(this.zscii_to_text(S));S.pc=Q;this.e.jit[R]=S;if(R<this.e.staticmem){x.warn("Caching a string in dynamic memory: "+R)}}return S},encode:function(O){var P=this.alphabets,N=[],M=0,L,K,J=[];while(N.length<9){L=O[M++];if(L==32){N.push(0)}K=P[0].indexOf(L);if(K>=0){N.push(K+6)}K=P[1].indexOf(L);if(K>=0){N.push(4,K+6)}K=P[2].indexOf(L);if(K>=0){N.push(5,K+6)}K=this.reverse_unicode_table[L];if(K){N.push(5,6,K>>5,K&31)}if(L==k){N.push(5)}}N.length=9;M=0;while(M<9){J.push(N[M++]<<2|N[M]>>3,(N[M++]&7)<<5|N[M++])}J[4]|=128;return J},zscii_to_text:function(J){return String.fromCharCode.apply(this,J).replace(/[\x00-\x0C\x0E-\x1F\x7F-\x9A\xFC-\uFFFF]/g,"").replace(/\r/g,"\n").replace(/[\x9B-\xFB]/g,this.unicode_callback)},text_to_zscii:function(N,M){var O=[],K=0,J=N.length,L;M=!M;while(K<J){L=N.charCodeAt(K++);if(M&&L!=13&&(L<32||L>126)){L=this.reverse_unicode_table[L]||63}O.push(L)}return O},parse_dict:function(Q){var P=this.e.m,J=Q,O={},N,M,L,K,N=P.getUint8(Q++);O.separators=P.getBuffer(Q,N);Q+=N;M=P.getUint8(Q++);L=Q+2+M*P.getUint16(Q);Q+=2;while(Q<L){O[""+P.getBuffer(Q,6)]=Q;Q+=M}this.dictionaries[J]=O;return O},tokenise:function(W,N,V,T){V=V||this.dict;V=this.dictionaries[V]||this.parse_dict(V);var O=this.e.m,P=W+2,R=P+O.getUint8(W+1),L,M=V.separators,J=[],U=[],K=P,Q,S=0;while(P<R){L=O.getUint8(P);if(L==32||M.indexOf(L)>=0){if(J.length){U.push([J,K]);J=[];K=P+1}if(L!=32){U.push([L,P])}}else{J.push(L)}P++}if(J.length){U.push([J,K])}Q=Math.min(U.length,O.getUint8(N));while(S<Q){J=this.encode(U[S][0]);if(T&&!V[J]){continue}O.setUint16(N+2+S*4,V[J]||0);O.setUint8(N+4+S*4,U[S][0].length);O.setUint8(N+5+S*4,U[S++][1])}O.setUint8(N+1,S)},keyinput:function(K){var J=K.charCode,L=K.keyCode;if(p[L]){return p[L]}if(J>31&&J<127){return J}return this.reverse_unicode_table[J]||63}});var t=function(J){return J.write()},B=s(a,function(){return 1}),F=y.subClass({write:function(L){var J=arguments.length,K=this.v;if(K.write||K==0){L=L&&L.write?L.write():L;K=K.write?K.write():K;return"e.indirect("+K+(J?","+L:"")+")"}return this._super(L)}}),n=h.subClass({storer:0,post:function(){var J=this.operands;J[0]=new F(this.e,J[0] instanceof y?J[0]:J[0].v);this.storer=this.code==142?J.pop():J.shift();if(J.length==0){J.push(new y(this.e,0))}},func:t}),H=w.subClass({func:function(K){var L=K.v-1,J=this.code%2?1:-1;if(K instanceof y||L>14){return"e.incdec("+K.write()+","+J+")"}return(L<0?"e.s[e.s.length-1]=e.S2U(e.s[e.s.length-1]+":("e.l["+L+"]=e.S2U(e.l["+L+"]+"))+J+")"}}),o={1:s(a,function(){return arguments.length==2?this.args("=="):"e.jeq("+this.args()+")"}),2:s(a,function(K,J){return K.U2S()+"<"+J.U2S()}),3:s(a,function(K,J){return K.U2S()+">"+J.U2S()}),4:s(a,function(J,K){return"e.U2S(e.incdec("+J.write()+",-1))<"+K.U2S()}),5:s(a,function(J,K){return"e.U2S(e.incdec("+J.write()+",1))>"+K.U2S()}),6:s(a,function(){return"e.jin("+this.args()+")"}),7:s(a,function(){return"e.test("+this.args()+")"}),8:s(h,function(){return this.args("|")}),9:s(h,function(){return this.args("&")}),10:s(a,function(){return"e.test_attr("+this.args()+")"}),11:s(w,function(){return"e.set_attr("+this.args()+")"}),12:s(w,function(){return"e.clear_attr("+this.args()+")"}),13:n,14:s(w,function(){return"e.insert_obj("+this.args()+")"}),15:s(h,function(K,J){return"m.getUint16("+K.write()+"+2*"+J.U2S()+")"}),16:s(h,function(K,J){return"m.getUint8("+K.write()+"+"+J.U2S()+")"}),17:s(h,function(){return"e.get_prop("+this.args()+")"}),18:s(h,function(){return"e.find_prop("+this.args()+")"}),19:s(h,function(){return"e.find_prop("+this.args(",0,")+")"}),20:s(h,function(){return"e.S2U("+this.args("+")+")"}),21:s(h,function(){return"e.S2U("+this.args("-")+")"}),22:s(h,function(){return"e.S2U("+this.args("*")+")"}),23:s(h,function(K,J){return"e.S2U(parseInt("+K.U2S()+"/"+J.U2S()+"))"}),24:s(h,function(K,J){return"e.S2U("+K.U2S()+"%"+J.U2S()+")"}),25:A,26:i,27:s(w,function(){return"e.ui.set_colour("+this.args()+")"}),28:s(I,function(K,J){return"while(e.call_stack.length>"+J.write()+"){e.call_stack.shift()}e.ret("+K.write()+")"}),128:s(a,function(J){return J.write()+"==0"}),129:s(q,function(J){return this.storer.write("e.get_sibling("+J.write()+")")}),130:s(q,function(J){return this.storer.write("e.get_child("+J.write()+")")}),131:s(h,function(J){return"e.get_parent("+J.write()+")"}),132:s(h,function(J){return"e.get_prop_len("+J.write()+")"}),133:H,134:H,135:s(w,function(J){return"e.print(e.text.decode("+J.write()+"))"}),136:A,137:s(w,function(J){return"e.remove_obj("+J.write()+")"}),138:s(w,function(){return"e.print_obj("+this.args()+")"}),139:s(I,function(J){return"e.ret("+J.write()+")"}),140:s(I,function(J){return"e.pc="+J.U2S()+"+"+(this.next-2)}),141:s(w,function(J){return"e.print(e.text.decode("+J.write()+"*"+this.e.packing_multipler+"))"}),142:n.subClass({storer:1}),143:i,176:s(I,function(){return"e.ret(1)"}),177:s(I,function(){return"e.ret(0)"}),178:s(w,function(J){return'e.print("'+J+'")'},{printer:1}),179:s(I,function(J){return'e.print("'+J+'");e.ret(1)'},{printer:1}),180:w,183:s(I,function(){return'e.act("restart")'}),184:s(I,function(J){return"e.ret("+J.write()+")"},{post:function(){this.operands.push(new y(this.e,0))}}),185:s(h,function(){return"e.call_stack.length"}),186:s(I,function(){return'e.act("quit")'}),187:s(w,function(){return'e.print("\\n")'}),189:B,191:B,224:A,225:s(w,function(L,J,K){return"m.setUint16("+L.write()+"+2*"+J.U2S()+","+K.write()+")"}),226:s(w,function(L,J,K){return"m.setUint8("+L.write()+"+"+J.U2S()+","+K.write()+")"}),227:s(w,function(){return"e.put_prop("+this.args()+")"}),228:s(r,function(){return"e.read("+this.args()+","+this.storer.v+")"}),229:s(w,function(J){return"e.print(e.text.zscii_to_text(["+J.write()+"]))"}),230:s(w,function(J){return"e.print("+J.U2S()+")"}),231:s(h,function(J){return"e.random("+J.U2S()+")"}),232:s(h,t,{post:function(){this.storer=new y(this.e,0)},storer:0}),233:n,234:s(w,function(){return"e.ui.split_window("+this.args()+")"}),235:s(w,function(){return"e.ui.set_window("+this.args()+")"}),236:A,237:s(w,function(J){return"e.ui.erase_window("+J.U2S()+")"}),238:s(w,function(){return"e.ui.erase_line("+this.args()+")"}),239:s(w,function(){return"e.ui.set_cursor("+this.args()+")"}),240:s(r,function(){return"e.ui.get_cursor("+this.args()+")"}),241:s(w,function(J){return"e.ui.set_style("+J.write()+")"}),242:w,243:s(w,function(){return"e.output_stream("+this.args()+")"}),244:w,245:w,246:s(r,function(){return"e.read_char("+this.args()+","+this.storer.v+")"}),247:s(q,function(){return this.storer.write("e.scan_table("+this.args()+")")}),248:s(h,function(J){return"e.S2U(~"+J.write()+")"}),249:i,250:i,251:s(w,function(){return"e.text.tokenise("+this.args()+")"}),252:s(w,function(){return"e.encode_text("+this.args()+")"}),253:s(w,function(){return"e.copy_table("+this.args()+")"}),254:s(w,function(){return"e.print_table("+this.args()+")"}),255:s(a,function(J){return J.write()+"<=e.call_stack[0][4]"}),1000:s(r,function(){return"e.save("+(this.next-1)+","+this.storer.v+")"}),1001:s(r,function(){return'e.act("restore",{storer:'+this.storer.v+"})"}),1002:s(h,function(K,J){return"e.S2U(e.log_shift("+K.write()+","+J.U2S()+"))"}),1003:s(h,function(K,J){return"e.S2U(e.art_shift("+K.U2S()+","+J.U2S()+"))"}),1004:s(h,function(){return"e.ui.set_font("+this.args()+")"}),1009:s(h,function(){return"e.save_undo("+this.next+","+this.storer.v+")"}),1010:s(w,function(){return"if(e.restore_undo())return"},{storer:1}),1011:s(w,function(J){return"e.print(String.fromCharCode("+J.write()+"))"}),1012:s(h,function(){return 3})};var D=function(N,L){var M=0,J,Q,K,P,O;while(M<N.ops.length-1){if(N.ops[M].offset==L){if(N.ops.length-M==2&&N.ops[M+1].offset){P=N.ops.pop();O=N.ops.pop();O.cond.invert=!O.cond.invert;P.cond=new d([O.cond,P.cond],"&&");P.labels=O.labels.concat(P.labels);N.ops.push(P);return 1}J=new v(N.e,N.ops[M+1].pc);J.ops=N.ops.slice(M+1);Q=J.ops.length-1;N.ops.length=M+1;K=N.ops[M];K.result=J;K.cond.invert=!K.cond.invert;P=J.ops[Q];if(P.code==140&&(j(P.operands[0].v)+P.next-2)==K.pc){K.keyword="while";J.ops.pop()}else{J.stopper=P.stopper}return 1}M++}};var c=function(O){var P,L,M=O.m,R,K,Q,S,N,J=new u(O,O.pc);while(1){L=P=O.pc;K=M.getUint8(P++);if(K==190){S=-1;K=M.getUint8(P++)+1000}else{if(K&128){if(K&64){S=-1;if(!(K&32)){K&=31}}else{S=[(K&48)>>4];if(S[0]<3){K&=207}}}else{S=[K&64?2:1,K&32?2:1];K&=31}}if(!o[K]){x.log("Missing opcode #"+K+" at pc="+L);x.log(J.write());O.stop=1;throw Error}Q=o[K].prototype;if(S==-1){S=[];g(M.getUint8(P++),S);if(K==236||K==250){g(M.getUint8(P++),S)}}N=[];R=0;while(R<S.length){if(S[R]==0){N.push(new m(O,M.getUint16(P)));P+=2}if(S[R]==1){N.push(new m(O,M.getUint8(P++)))}if(S[R++]==2){N.push(new y(O,M.getUint8(P++)))}}if(Q.storer){N.push(new y(O,M.getUint8(P++)))}if(Q.brancher){R=M.getUint8(P++);N.push([R&128,R&64?R&63:((R=(R<<8)|M.getUint8(P++))&8192?~8191:0)|(R&8191)])}if(Q.printer){R=O.text.decode(P);N.push(R.replace(/\n/g,"\\n").replace(/"/g,'\\"'));P=R.pc}O.pc=P;J.ops.push(new o[K](O,J,K,L,P,N));R=0;if(J.targets.indexOf(P)>=0){R=D(J,P)}if(Q.stopper&&!R){break}}return J},g=function(K,L){for(var J=0;J<4;J++){L.push((K&192)>>6);K<<=2}};l.ZVM=Object.subClass({art_shift:function(K,J){return J>0?K<<J:K>>-J},call:function(Q,J,N,L){var M,K,P=this.l.length,O=L.length;this.pc=Q*this.packing_multipler;K=this.m.getUint8(this.pc++);L=L.slice(0,K);for(M=L.length;M<K;M++){L.push(0)}this.l=L.concat(this.l);this.call_stack.unshift([N,J,K,this.s.length,O,P])},clear_attr:function(J,K){var L=this.objects+14*J+parseInt(K/8);this.m.setUint8(L,this.m.getUint8(L)&~(128>>K%8))},copy_table:function(N,K,M){var P=this.m,L=0,O=M<0,J;M=Math.abs(M);if(K==0){while(L<M){P.setUint8(N+L++,0)}return}J=P.getBuffer(N,M);P.setBuffer(K,J);if(!O){P.setBuffer(N,J)}},encode_text:function(K,J,M,L){this.m.setBuffer(L,this.text.encode(this.m.getBuffer(K+M,J)))},extension_table:function(K,J){var L=this.extension;if(!L||K>this.extension_count){return 0}L+=2*K;if(J==k){return this.m.getUint16(L)}this.e.setUint16(L,J)},find_prop:function(J,N,M){var Q=this.m,P,O,L=0,K=Q.getUint16(this.objects+14*J+12);K+=Q.getUint8(K)*2+1;P=Q.getUint8(K);O=P&63;while(1){if(L==M){return O}if(O==N){return K+(P&128?2:1)}if(O<N){return 0}L=O;if(P&128){O=Q.getUint8(K+1)&63;K+=O?O+2:66}else{K+=P&64?3:2}P=Q.getUint8(K);O=P&63}},get_child:function(J){return this.m.getUint16(this.objects+14*J+10)},get_sibling:function(J){return this.m.getUint16(this.objects+14*J+8)},get_parent:function(J){return this.m.getUint16(this.objects+14*J+6)},get_prop:function(J,K){var M=this.m,L=this.find_prop(J,K);if(L){return(M.getUint8(L-1)&64?M.getUint16:M.getUint8)(L)}return M.getUint16(this.properties+2*(K-1))},get_prop_len:function(K){if(K==0){return 0}var J=this.m.getUint8(K-1);if(J&128){J&=63;return J==0?64:J}return J&64?2:1},incdec:function(K,M){var J,L;if(K==0){J=e(this.s.pop()+M);this.s.push(J);return J}if(K<16){return this.l[K-1]=e(this.l[K-1]+M)}else{L=this.globals+(K-16)*2;return this.m.setUint16(L,this.m.getUint16(L)+M)}},indirect:function(J,K){if(J==0){if(arguments.length>1){return this.s[this.s.length-1]=K}else{return this.s[this.s.length-1]}}return this.variable(J,K)},insert_obj:function(K,J){this.remove_obj(K);this.set_family(K,J,J,K,K,this.get_child(J))},jeq:function(){var J=1,K;while(J<arguments.length){if(arguments[J++]==arguments[0]){K=1}}return K},jin:function(K,J){return this.get_parent(K)==J},log_shift:function(K,J){return J>0?K<<J:K>>>-J},output_stream:function(L,M){L=j(L);if(L==1){this.streams[0]=1}if(L==-1){this.streams[0]=0}if(L==3){this.streams[2].unshift([M,""])}if(L==-3){var J=this.streams[2].shift(),K=this.text.text_to_zscii(J[1]);this.m.setUint16(J[0],K.length);this.m.setBuffer(J[0]+2,K)}},print:function(K){if(this.streams[2].length){this.streams[2][0][1]+=K}else{if(this.streams[0]){var J=this.m.getUint8(17)&2;if(J!=(this.ui.mono&2)){if(!(this.ui.mono&253)){this.ui.flush()}this.ui.mono^=2}this.ui.buffer+=K}}},print_obj:function(K){var J=this.m.getUint16(this.objects+14*K+12);this.print(this.text.decode(J+1,this.m.getUint8(J)*2))},print_table:function(N,L,J,M){J=J||1;M=M||0;var K=0;while(K<J){this.print("\n"+this.text.zscii_to_text(this.m.getBuffer(N,L)));N+=L+M;K++}},put_prop:function(J,L,K){var N=this.m,M=this.find_prop(J,L);(N.getUint8(M-1)&64?N.setUint16:N.setUint8)(M,K)},random:function(J){var K;if(J<1){this.random_state=Math.abs(J);this.random_seq=0;return 0}if(this.random_state==0){return parseInt(Math.random()*J)+1}else{this.random_seq++;if(this.random_seq>this.random_state){this.random_seq=1}return this.random_seq%J}},read:function(N,M,L,J,K){if(arguments.length==3){K=L;L=J=0}this.act("read",{buffer:N,parse:M,len:this.m.getUint8(N),initiallen:this.m.getUint8(N+1),time:L,routine:J,storer:K})},read_char:function(L,M,J,K){if(arguments.length==2){K=M;M=J=0}this.act("char",{time:M,routine:J,storer:K})},remove_obj:function(N){var M=this.get_parent(N),K,L,J;if(M==0){return}K=this.get_child(M);L=this.get_sibling(N);if(K==N){this.set_family(N,0,M,L)}else{while(1){J=this.get_sibling(K);if(J==N){break}K=J}this.set_family(N,0,0,0,K,L)}},restore:function(O){var L=new G(O),M=L.memory,Q=L.stacks,S=L.pc,T=this.m.getUint8(17),U,P=0,N=0,R=[],K=[],J;this.m.setBuffer(0,this.data.slice(0,this.staticmem));if(L.compressed){while(P<M.length){U=M[P++];if(U==0){N+=1+M[P++]}else{this.m.setUint8(N,U^this.data[N++])}}}else{this.m.setBuffer(0,L.memory)}this.m.setUint8(17,T);P=6;U=Q[P++]<<8|Q[P++];J=b(Q.slice(P,U));while(P<Q.length){R.unshift([Q[P++]<<16|Q[P++]<<8|Q[P++],0,0,J.length,0,K.length]);R[0][1]=Q[P]&16?-1:Q[P+1];R[0][2]=Q[P]&15;P+=2;U=Q[P++];while(U){R[0][4]++;U>>=1}U=Q[P++]<<8|Q[P++];K=b(Q.slice(P,P+R[0][2])).concat(K);P+=R[0][2]*2;J=J.concat(b(Q.slice(P,U)))}this.call_stack=R;this.l=K;this.s=J;this.update_header();this.variable(this.m.getUint8(S++),2);this.pc=S},restore_undo:function(){if(this.undo.length==0){return 0}var J=this.undo.pop();this.pc=J[0];J[2][17]=this.m.getUint8(17);this.m.setBuffer(0,J[2]);this.l=J[3];this.s=J[4];this.call_stack=J[5];this.variable(J[1],2);return 1},ret:function(J){var L=this.call_stack.shift(),K=L[1];this.pc=L[0];this.l=this.l.slice(this.l.length-L[5]);this.s.length=L[3];if(K>=0){this.variable(K,J)}},save:function(U,X){var Q=this.m,V=this.s,L=this.l,N=new G(),P=[],R,O,S,W=0,T=this.call_stack.reverse(),K,M,J=[0,0,0,0,0,0];N.release=Q.getBuffer(2,2);N.serial=Q.getBuffer(18,6);N.checksum=Q.getBuffer(28,2);N.pc=U;N.compressed=1;for(R=0;R<this.staticmem;R++){S=Q.getUint8(R)^this.data[R];if(S==0){if(++W==256){P.push(0,255);W=0}}else{if(W){P.push(0,W-1);W=0}P.push(S)}}N.memory=P;J.push(T[0][3]>>8,T[0][3]&255);for(O=0;O<T[0][3];O++){J.push(V[O]>>8,V[O]&255)}for(R=0;R<T.length;R++){K=T[R];M=(T[R+1]?T[R+1][3]:V.length)-K[3];J.push(K[0]>>16,K[0]>>8&255,K[0]&255,K[2]|(K[1]<0?16:0),K[1]<0?0:K[1],(1<<K[4])-1,M>>8,M&255);for(O=L.length-K[5]-K[2];O<L.length-K[5];O++){J.push(L[O]>>8,L[O]&255)}for(O=K[3];O<K[3]+M;O++){J.push(V[O]>>8,V[O]&255)}}T.reverse();N.stacks=J;this.variable(X,1);this.act("save",{data:N.write()})},save_undo:function(K,J){this.undo.push([K,J,this.m.getBuffer(0,this.staticmem),this.l.slice(),this.s.slice(),this.call_stack.slice()]);return 1},scan_table:function(J,N,L,K){K=K||130;var M=K&128?this.m.getUint16:this.m.getUint8;K&=127;L=N+L*K;while(N<L){if(M(N)==J){return N}N+=K}return 0},set_attr:function(J,K){var L=this.objects+14*J+parseInt(K/8);this.m.setUint8(L,this.m.getUint8(L)|128>>K%8)},set_family:function(L,M,K,O,J,N){this.m.setUint16(this.objects+14*L+6,M);if(K){this.m.setUint16(this.objects+14*K+10,O)}if(J){this.m.setUint16(this.objects+14*J+8,N)}},test:function(K,J){return K&J==J},test_attr:function(J,K){return(this.m.getUint8(this.objects+14*J+parseInt(K/8))<<K%8)&128},variable:function(K,L){var J=L!==k;if(K==0){if(J){this.s.push(L)}else{return this.s.pop()}}else{if(K<16){if(J){this.l[K-1]=L}else{return this.l[K-1]}}else{if(J){this.m.setUint16(this.globals+(K-16)*2,L)}else{this.m.getUint16(this.globals+(K-16)*2)}}}return L},U2S:j,S2U:e,init:function(){this.jit={};this.env={width:80}},inputEvent:function(L){var M=this.m,K=L.code,J;if(L.env){C(this.env,L.env);if(!K){return}}this.orders=[];if(K=="load"){this.data=L.data;return}if(K=="restart"){this.restart()}if(K=="restore"){if(L.data){this.restore(L.data)}else{this.variable(L.storer,0)}}if(K=="read"){this.variable(L.storer,L.terminator);J=L.response;this.print(J+"\n");J=this.text.text_to_zscii(J.toLowerCase());if(J.length>L.len){J=J.slice(0,L.len)}M.setUint8(L.buffer+1,J.length);M.setBuffer(L.buffer+2,J);if(L.parse){this.text.tokenise(L.buffer,L.parse)}}if(K=="char"){this.variable(L.storer,this.text.keyinput(L.response))}if(K=="get_cursor"){M.setUint16(L.addr,L.pos[0]);M.setUint16(L.addr+2,L.pos[1])}this.run()},restart:function(){var M=f(this.data),J=M.getUint8(0),K=M.getUint16(10),L=M.getUint16(54);if(J!=5&&J!=8){throw new Error("Unsupported Z-Machine version: "+J)}if(this.m){M.setUint8(17,this.m.getUint8(17))}C(this,{m:M,s:[],l:[],call_stack:[],undo:[],orders:[],streams:[1,0,[],0],version:J,pc:M.getUint16(6),properties:K,objects:K+112,globals:M.getUint16(12),staticmem:M.getUint16(14),extension:L,extension_count:L?M.getUint16(L):0,packing_multipler:J==5?4:8});C(this,{ui:new ZVMUI(this,M.getUint8(17)&2),text:new z(this)});this.update_header()},update_header:function(){var J=this.m;this.random_state=0;J.setUint8(1,29|(this.env.timed?128:0));J.setUint8(17,J.getUint8(17)&87);J.setUint8(32,255);J.setUint8(33,this.env.width);J.setUint16(34,this.env.width);J.setUint16(36,255);J.setUint16(38,257);J.setUint8(50,1);J.setUint8(51,this.env.PARCHMENT_SECURITY_OVERRIDE?2:0);this.extension_table(4,0)},run:function(){var K=Date.now(),J;this.stop=0;while(!this.stop){J=this.pc;if(!this.jit[J]){this.compile()}this.jit[J](this);if((Date.now()-K)>5000){this.act("tick");return}}},compile:function(){var J=c(this),K=J.write();this.jit[J.pc]=new Function("e",K);if(J.pc<this.staticmem){x.warn("Caching a JIT function in dynamic memory: "+J.pc)}},act:function(K,J){var J=J||{};this.ui.flush();if(this.ui.status.length){this.orders.push({code:"stream",to:"status",data:this.ui.status});this.ui.status=[]}J.code=K;this.orders.push(J);this.stop=1;this.outputEvent(this.orders)}})})(this);